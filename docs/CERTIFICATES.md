# SSL Certificate Setup Guide

This guide explains how to set up SSL certificates for the Secure Gateway Server.

## Quick Start (Development)

### 1. Generate Self-Signed Certificates

```bash
# Run the certificate generation script
./scripts/generate-dev-certs.sh
```

This will create:
- `./certs/server.key` - Server private key
- `./certs/server.crt` - Server certificate
- `./certs/client.key` - Client private key (for mTLS)
- `./certs/client.crt` - Client certificate (for mTLS)
- `./certs/ca.key` - CA private key
- `./certs/ca.crt` - CA certificate

### 2. Start Server with HTTPS

```bash
NODE_ENV=development node src/server.js
```

The server will automatically detect the certificates and start with HTTPS.

## Certificate Types

### 1. Server Certificates (HTTPS)

**Purpose**: Enable HTTPS for the gateway server
**Files**: `server.key`, `server.crt`

**Development (Self-Signed)**:
```bash
./scripts/generate-dev-certs.sh
```

**Production (Trusted CA)**:
- Purchase from a Certificate Authority (Let's Encrypt, DigiCert, etc.)
- Place certificates in `./certs/` directory
- Ensure proper file permissions (600 for keys, 644 for certs)

### 2. Client Certificates (mTLS)

**Purpose**: Mutual TLS authentication with private API
**Files**: `client.key`, `client.crt`, `ca.crt`

**Development**: Generated by the script above
**Production**: Obtain from your private API provider

## Environment Variables

### Server Certificates
```bash
SSL_KEY_PATH=./certs/server.key
SSL_CERT_PATH=./certs/server.crt
```

### Client Certificates (mTLS)
```bash
CLIENT_CERT_PATH=./certs/client.crt
CLIENT_KEY_PATH=./certs/client.key
CA_CERT_PATH=./certs/ca.crt
```

## Production Setup

### Option 1: Let's Encrypt (Free)

```bash
# Install certbot
sudo apt-get install certbot

# Generate certificates
sudo certbot certonly --standalone -d yourdomain.com

# Copy certificates to your app
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem ./certs/server.key
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem ./certs/server.crt

# Set proper permissions
sudo chown $USER:$USER ./certs/server.key ./certs/server.crt
chmod 600 ./certs/server.key
chmod 644 ./certs/server.crt
```

### Option 2: Commercial CA

1. Generate CSR (Certificate Signing Request)
2. Submit to CA (DigiCert, GlobalSign, etc.)
3. Download and install certificates
4. Place in `./certs/` directory

### Option 3: Railway/Cloud Platform

Most cloud platforms handle SSL automatically:

**Railway**:
- SSL is automatically provisioned
- No manual certificate setup needed
- Set `NODE_ENV=production`

**Heroku**:
- SSL is automatically provisioned
- Custom domains require SSL add-on

**AWS/GCP/Azure**:
- Use Load Balancer SSL termination
- Or use platform certificate management

## Certificate Validation

### Check Certificate Details
```bash
# View certificate information
openssl x509 -in ./certs/server.crt -text -noout

# Check certificate expiration
openssl x509 -in ./certs/server.crt -noout -dates

# Verify certificate chain
openssl verify ./certs/server.crt
```

### Test HTTPS Connection
```bash
# Test with curl
curl -k https://localhost:3001/api/health

# Test with proper certificate validation
curl --cacert ./certs/server.crt https://localhost:3001/api/health
```

## Security Best Practices

### 1. File Permissions
```bash
# Private keys should be readable only by owner
chmod 600 ./certs/*.key

# Certificates can be readable by all
chmod 644 ./certs/*.crt
```

### 2. Certificate Rotation
- Monitor certificate expiration dates
- Set up automated renewal (Let's Encrypt)
- Plan for certificate rotation

### 3. Key Management
- Store private keys securely
- Use hardware security modules (HSM) in production
- Never commit private keys to version control

### 4. Certificate Monitoring
```bash
# Check expiration dates
openssl x509 -in ./certs/server.crt -noout -enddate

# Set up monitoring alerts
# Example: Alert when certificate expires in < 30 days
```

## Troubleshooting

### Common Issues

**1. Certificate Not Found**
```
Error: ENOENT: no such file or directory, open './certs/server.key'
```
**Solution**: Run `./scripts/generate-dev-certs.sh`

**2. Permission Denied**
```
Error: EACCES: permission denied, open './certs/server.key'
```
**Solution**: `chmod 600 ./certs/server.key`

**3. Certificate Expired**
```
Error: certificate has expired
```
**Solution**: Renew or replace certificates

**4. Self-Signed Certificate Warning**
```
Warning: Self-signed certificate
```
**Solution**: Accept in development, use trusted CA in production

### Debug Commands

```bash
# Check if certificates exist
ls -la ./certs/

# Verify certificate format
openssl x509 -in ./certs/server.crt -text -noout

# Test server startup
NODE_ENV=development node src/server.js

# Check server logs for certificate errors
```

## Development vs Production

| Aspect | Development | Production |
|--------|-------------|------------|
| Certificate Type | Self-signed | Trusted CA |
| Validation | Disabled | Enabled |
| Renewal | Manual | Automated |
| Security | Basic | High |
| Browser Warnings | Yes | No |

## Next Steps

1. **Development**: Run `./scripts/generate-dev-certs.sh`
2. **Testing**: Verify HTTPS works with `curl -k https://localhost:3001/api/health`
3. **Production**: Obtain certificates from trusted CA
4. **Monitoring**: Set up certificate expiration alerts

For more information, see the [Node.js HTTPS documentation](https://nodejs.org/api/https.html). 